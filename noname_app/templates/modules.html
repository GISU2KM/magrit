<!DOCTYPE html>
<html>
  <head>
    <meta  content="text/html" charset="utf-8"  http-equiv="content-type">
    <meta  http-equiv="X-UA-Compatible"  content="IE=edge">
    <meta  name="viewport"  content="width=device-width, initial-scale=1, user-scalable=yes">
    <title> {{ app_name }} </title>
    <link href="static/css/discretization.css" rel="stylesheet" type="text/css">
    <link href="static/css/scoped-bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="static/css/style-slider.min.css" rel="stylesheet"  type="text/css">
    <link href="static/css/style-fonts.css" rel="stylesheet"  type="text/css">
    <link href="static/css/style.css" rel="stylesheet"  type="text/css">
    <link href="static/css/vanilla-dataTables.min.css" rel="stylesheet" type="text/css">
    <link href="static/css/context-menu.css" rel="stylesheet" type="text/css">
    <link href="static/css/sweetalert2.min.css" rel="stylesheet" type="text/css">
    <script  src="static/js/lib/d3.v4.min.js"></script>
    <script  src="static/js/lib/d3-geo-projection.v1.min.js"></script>
    <script  src="static/js/lib/d3-selection-multi.v1.min.js"></script>
    <script  src="static/js/lib/topojson.v1.min.js"></script>
    <script  src="static/js/lib/bootstrap-native-mod.min.js"></script>
    <script  src="static/js/lib/geostats.min.js"></script>
    <script  src="static/js/lib/colorbrewer.v1.min.js"></script>
    <!-- <script  src="/static/js/lib/jschardet.min.js"></script> -->
    <script  src="static/js/lib/q.min.js"></script>
    <script  src="static/js/lib/i18next.min.js"></script>
    <script  src="static/js/lib/loc-i18next.min.js"></script>
    <script  src="static/js/lib/i18nextXHRBackend.min.js"></script>
    <script  src="static/js/lib/sweetalert2.min.js"></script>
    <script  src="static/js/lib/vanilla-dataTables.min.js"></script>
    <script  src="static/js/lib/Sortable.min.js"></script>
    <!-- <script  src="/static/js/app.min.js"></script> -->

    <script  src="static/js/context-menu.js"></script>
    <script  src="static/js/layout_features.js"></script>
    <script  src="static/js/interface.js"></script>
    <script  src="static/js/map_project.js"></script>
    <script  src="static/js/discrtiz_links_discont.js"></script>
    <script  src="static/js/layers_style_popup.js"></script>
    <script  src="static/js/discretization_panel.js"></script>
    <script  src="static/js/function.js"></script>
    <script  src="static/js/legend.js"></script>
    <script  src="static/js/join_popup.js"></script>
    <script  src="static/js/colors_helpers.js"></script>

  </head>
  <body>
      <div id="header">
        <p style="display:inline;margin-left:15px;">
        <a href="/"><img src="/static/img/magrit.png" alt="Export" height="20" style="position: absolute; top: 6px;"></a>
        </p>
        <p id="rgt" class="header_options"></p></div>
      <div id="menu"></div>
      <div id="twbs" class="twbs"></div>
  	 <div id="map"></div>
      <a id="downloadAnchorElem" style="display:none"></a>
<script>
"use strict";
/**
* Function setting-up main elements of the interface
*
* Some of the variables created here are put in global/window scope
* as they are gonna be frequently used
*
*/
function setUpInterface(resume_project)
{
    let bg = document.createElement('div');
    bg.id = 'overlay';
    bg.style.display = "none";
    bg.style.textAlign = "center";
    bg.innerHTML = '<span class="i18n" style="color: white; z-index: 2;margin-top:185px;display: inline-block;" data-i18n="[html]app_page.common.loading_results"></span>' +
                   '<span style="color: white; z-index: 2;">...<br></span>' +
                   '<span class="i18n" style="color: white; z-index: 2;display: inline-block;" data-i18n="[html]app_page.common.long_computation"></span><br>' +
                   '<div class="load-wrapp" style="left: calc(50% - 60px);position: absolute;top: 50px;"><div class="load-1"><div class="line"></div>' +
                   '<div class="line"></div><div class="line"></div></div></div>';
    let btn = document.createElement("button");
    btn.className = "button_st3 i18n"
    btn.setAttribute("data-i18n", "[html]app_page.common.cancel");
    bg.appendChild(btn)
    document.body.appendChild(bg);

    let bg_drop = document.createElement('div');
    bg_drop.className = "overlay_drop";
    bg_drop.id = 'overlay_drop';
    bg_drop.style = "background: black; opacity:0.6;display: none;padding: 10px;";
    let inner_div = document.createElement("div");
    inner_div.style.border = "dashed 2px white";
    inner_div.style.margin = "10px";
    inner_div.style.background = "rgba(0, 0, 0, 0.33)";
    inner_div.style.borderRadius = "1%";
    inner_div.className = "overlay_drop";
    let inner_p = document.createElement("p");
    inner_p.style = "position: fixed;top: 50%;left: 50%;transform: translateX(-50%)translateY(-50%);font-size: 14px;width: auto;bottom: 0px;opacity: 0.85;text-align: center;color: white;padding: 0.5em;"
    inner_p.innerHTML = "Drop your file(s) in the window ...";
    inner_div.appendChild(inner_p);
    bg_drop.appendChild(inner_div);
    document.body.appendChild(bg_drop);

    let menu = d3.select("#menu"),
        b_accordion1 = menu.append("button").attr("id", "btn_s1").attr("class", "accordion i18n").attr("data-i18n", "app_page.section1.title"),
        accordion1 = menu.append("div").attr("class", "panel").attr("id", "accordion1"),
        b_accordion2 = menu.append("button").attr("id", "btn_s2").attr("class", "accordion i18n").attr("data-i18n", "app_page.section2_pre.title"),
        accordion2_pre = menu.append("div").attr("class", "panel").attr("id", "accordion2_pre"),
        b_accordion3 = menu.append("button").attr("id", "btn_s3").attr("class", "accordion i18n").attr("data-i18n", "app_page.section3.title"),
        accordion3 = menu.append("div").attr("class", "panel").attr("id", "accordion3"),
        b_accordion4 = menu.append("button").attr("id", "btn_s4").attr("class", "accordion i18n").attr("data-i18n", "app_page.section4.title"),
        accordion4 = menu.append("div").attr("class", "panel").attr("id", "accordion4"),
        b_accordion5 = menu.append("button").attr("id", "btn_s5").attr("class", "accordion i18n").attr("data-i18n", "app_page.section5b.title"),
        accordion5 = menu.append("div").attr("class", "panel").attr("id", "accordion5b");

    window.section1 =  accordion1.append("div")
                        .attr("id","section1")
                        .attr("class", "i18n")
                        .attr("data-i18n", "[tooltip-title]app_page.tooltips.section1");
    window.section2_pre =  accordion2_pre.append("div").attr("id","section2_pre");
    accordion3.append("div")
        .attrs({id: "section3", class: "i18n", "data-i18n": "[tooltip-title]app_page.tooltips.section3"}),
    accordion4.append("div").attr("id","section4");
    accordion5.append("div").attr("id","section5");

    let dv1 = section1.append("div"),
        dv11 = dv1.append("div").style("width", "auto");

    dv11.append("img")
        .attrs({"id": "img_in_geom", "class": "user_panel", "src": "/static/img/b/addgeom.png", "width": "26", "height": "26",  "alt": "Geometry layer"})
        .style("cursor", "pointer")
        .on('click',  click_button_add_layer);

    dv11.append("p")
        .attrs({id: "input_geom", class: "user_panel i18n"})
        .styles({display: "inline", cursor: "pointer", "margin-left": "5px", "vertical-align": "super", "font-weight": "bold"})
        .attr("data-i18n", "[html]app_page.section1.add_geom")
        .on('click',  click_button_add_layer);

    let dv12 = dv1.append("div");
    dv12.append("img")
        .attrs({"id": "img_data_ext", "class": "user_panel", "src": "/static/img/b/addtabular.png", "width": "26", "height": "26",  "alt": "Additional dataset"})
        .style("cursor", "pointer")
        .on('click',  click_button_add_layer);

    dv12.append("p")
        .attrs({"id": "data_ext", "class": "user_panel i18n"})
        .styles({display: "inline", cursor: "pointer", "margin-left": "5px", "vertical-align": "super", "font-weight": "bold"})
        .attr("data-i18n", "[html]app_page.section1.add_ext_dataset")
        .on('click',  click_button_add_layer);

    let div_sample = dv1.append("div").attr("id", "sample_zone");
    div_sample.append("img")
        .attrs({"id": "sample_button", "class": "user_panel", "src": "/static/img/b/addsample.png", "width": "26", "height": "26",  "alt": "Sample layers"})
        .style("cursor", "pointer")
        .on('click', add_sample_layer);

    div_sample.append("span")
        .attrs({"id": "sample_link", "class": "user_panel i18n"})
        .styles({display: "inline", cursor: "pointer", "margin-left": "5px", "vertical-align": "super", "font-weight": "bold"})
        .attr("data-i18n", "[html]app_page.section1.add_sample_data")
        .on('click', add_sample_layer);

    dv1.append("p")
        .attr("id", "join_section")
        .styles({"text-align": "center", "margin-top": "2px"})
        .html("");

    dv1.append("p")
        .attr("id", "browse_section")
        .attr("align", "center")
        .html("")
        .append("button")
        .attrs({id: "browse_button", class: "button_st3 i18n", disabled: true})
        .style("font-size", "12px")
        .attr("data-i18n", "[html]app_page.section1.explore_table")
        .on("click", () => {  boxExplore.create(); });

    make_ico_choice();

    //section2.append("p")
    //        .style("font-size", "18px")
    //        .attr("class", "i18n")
    //        .attr("data-i18n", "[html]app_page.section2.no_func");

    let section3 = d3.select("#section3");

    window.layer_list = section3.append("div")
                             .append("ul").attrs({id: "sortable", class: "layer_list"});

    let dv3 = section3.append("div")
                    .style("padding-top", "10px").html('');

    dv3.append("img")
        .attr("src", "/static/img/b/addsample_t.png")
        .styles({cursor: "pointer", margin: "2.5px", float: "right", "border-radius": "10%"})
        .on('click', add_layout_layers);
    dv3.append("img")
        .attr("src", "/static/img/b/addgeom_t.png")
        .styles({cursor: "pointer", margin: "2.5px", float: "right", "border-radius": "10%"})
        .on("click", click_button_add_layer);

    let section4 = d3.select("#section4");
    let dv4 = section4.append("div").attr("class", "form-item").style("margin", "auto")
                    .append("ul")
                    .styles({"list-style": "outside none none",
                             display: "inline-block",
                             padding: "0px",
                             width: "100%",
                             "margin-top": "0px"});

    let e = dv4.append("li").styles({margin: "1px", padding: "4px"});
    e.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_title");
    e.append("input").attr("class", "list_elem_section4")
            .attr("id", "title")
            .styles({"margin": "0px 0px 0px 3px"})
            .on("keyup", function(){
                handle_title(this.value);
            });
    e.insert("span")
            .styles({display: "inline", top: "4px", cursor: "pointer", "vertical-align": "sub"})
            .html(sys_run_button.replace("submit", "Title properties"))
            .on("click", handle_title_properties);

    let f = dv4.append("li").styles({margin: "1px", padding: "4px"});
    f.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.background_color");
    f.append("p").attr("class", "list_elem_section4")
            .insert("input")
            .styles({"margin-left": "15px"})
            .attrs({type: "color", id: "bg_color", value: "#ffffff"})
            .on("change", function(){
                handle_bg_color(this.value);
            });

    let _h = dv4.append("li").styles({margin: "1px", padding: "0px 4px"});
    _h.append("p")
            .attr("id", "btn_add_layout_ft")
            .style("cursor", "pointer")
            .html(i18next.t("app_page.section4.layout_features") + sys_run_button)
            .on("click", select_layout_features);
    _h.select("img").style("vertical-align", "sub");

    let a1 = dv4.append("li").styles({margin: "1px", padding: "4px"});
    a1.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_width");
    a1.append("input").attr("class", "list_elem_section4")
            .styles({position: "absolute", right: "20px"}).style("width", "80px").style("margin-left", "15px")
            .attrs({id: "input-width", type: "number", value: w})
            .on("change", function(){
                let ratio_type = document.getElementById("map_ratio_select").value;
                let new_width = +this.value;
                if(ratio_type == "portrait"){
                    h = round_value(new_width / 0.70707, 0);
                    canvas_mod_size([new_width, h]);
                } else if (ratio_type == "landscape"){
                    h = round_value(new_width * 0.70707, 0);
                    canvas_mod_size([new_width, h]);
                } else {
                    canvas_mod_size([this.value, null]);
                }
                document.getElementById("input-height").value = h;
            });


    let a2 = dv4.append("li").styles({margin: "1px", padding: "4px"});
    a2.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_height");
    a2.append("input").attr("class", "list_elem_section4")
            .styles({position: "absolute", right: "20px"}).style("width", "80px").style("margin-left", "15px")
            .attrs({id: "input-height", type: "number", "value": h})
            .on("change", function(){
                let ratio_type = document.getElementById("map_ratio_select").value;
                let new_height = +this.value;
                if(ratio_type == "portrait"){
                    w = round_value(new_height * 0.70707, 0);
                    canvas_mod_size([w, new_height]);
                } else if (ratio_type == "landscape"){
                    w = round_value(new_height / 0.70707, 0);
                    canvas_mod_size([w, new_height]);
                } else {
                    canvas_mod_size([null, this.value]);
                }
                document.getElementById("input-width").value = w;
            });

    let b = dv4.append("li").styles({margin: "1px", padding: "4px 0"});
    b.append("p").attr("class", "list_elem_section4 i18n")
            .style("padding", "4px")
            .attr("data-i18n", "[html]app_page.section4.map_ratio");
    let ratio_select = b.append("select")
            .attrs({"class": "list_elem_section4 i18n", "id": "map_ratio_select"})
            .styles({position: "absolute", right: "20px", "margin-left": "15px"});

    ratio_select.append("option").text("").attr("data-i18n", "[html]app_page.section4.ratio_user").attr("value", "ratio_user");
    ratio_select.append("option").text("").attr("data-i18n", "[html]app_page.section4.ratio_landscape").attr("value", "landscape");;
    ratio_select.append("option").text("").attr("data-i18n", "[html]app_page.section4.ratio_portait").attr("value", "portrait");
    ratio_select.on("change", function(){
        let current_ratio = w /h;
        if(this.value == "portrait"){
            if(current_ratio < 0.707){
                w = round_value(h * 0.70707, 0);
                canvas_mod_size([w, h]);
            } else {
                h = round_value(w / 0.70707, 0);
                canvas_mod_size([w, h]);
            }
        } else if (this.value == "landscape"){
            if(current_ratio > 0.707){
                w = round_value(h / 0.70707, 0);
                canvas_mod_size([w, h]);
            } else {
                h = round_value(w * 0.70707, 0);
                canvas_mod_size([w, h]);
            }
        document.getElementById("input-width").value = w;
        document.getElementById("input-height").value = h;
        }
    });
    let zoom_prop = svg_map.__zoom;

    let c = dv4.append("li").styles({margin: "1px", padding: "4px"});
    c.append("span").attr("id", "map_center_menu_ico")
        .attr("class", "ui-accordion-header-icon ui-icon ui-icon-triangle-1-e")
        .styles({"display": "inline-table", "vertical-align": "sub", "margin-left": "-5px"});
    c.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_center_menu")
            .style("cursor", "pointer");
    c.on("click", function(){
        let sections = document.querySelectorAll(".to_hide"),
            arg;
        if(sections[0].style.display == "none"){
            arg = "";
            document.getElementById("map_center_menu_ico").classList = "ui-accordion-header-icon ui-icon ui-icon-triangle-1-s";
        } else {
            arg = "none";
            document.getElementById("map_center_menu_ico").classList = "ui-accordion-header-icon ui-icon ui-icon-triangle-1-e";
        }
        sections[0].style.display = arg;
        sections[1].style.display = arg;
        sections[2].style.display = arg;
        let ico_menu = document.getElementById("map_center_menu_ico");
    });

    let c1 = dv4.append("li").styles({margin: "1px", padding: "4px", display: "none"}).attr("class", "to_hide");
    c1.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_center_x");
    c1.append("input")
            .styles({position: "absolute", right: "20px"}).style("width", "80px").style("margin-left", "15px")
            .attrs({id: "input-center-x", type: "number", "value": round_value(zoom_prop.x, 2), step: "any"})
            .on("change", function(){
                svg_map.__zoom.x = +this.value;
                zoom_without_redraw();
            });

    let c2 = dv4.append("li").styles({margin: "1px", padding: "4px", display: "none"}).attr("class", "to_hide");
    c2.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_center_y");

    c2.append("input").attr("class", "list_elem_section4")
            .attrs({id: "input-center-y", type: "number", "value": round_value(zoom_prop.y, 2), step: "any"})
            .styles({position: "absolute", right: "20px"}).style("width", "80px").style("margin-left", "15px");

    let d = dv4.append("li").styles({margin: "1px", padding: "4px", display: "none"}).attr("class", "to_hide");
    d.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.map_scale_k");
    d.append("input").attr("class", "list_elem_section4")
            .styles({position: "absolute", right: "20px"}).style("width", "80px").style("margin-left", "15px")
            .attrs({id: "input-scale-k",
                    type: "number",
                    value: round_value(zoom_prop.k * proj.scale(), 2),
                    step: "any"})
            .on("change", function(){
                svg_map.__zoom.k = +this.value / proj.scale();
                zoom_without_redraw();
            });

    let g = dv4.append("li").styles({margin: "1px", padding: "4px"});
    g.append("p").attr("class", "list_elem_section4 i18n")
            .attr("data-i18n", "[html]app_page.section4.canvas_rotation");
    g.append("input")
            .attr("type", "range")
            .attr("id","form_rotate")
            .attr("value", 0).attr("min", 0)
            .attr("max", 360).attr("step", 1)
            .styles({width: "80px", "margin": "9px 10px 9px 15px", "vertical-align": "middle"})
            .on("input", function(){
                rotate_global(this.value);
                document.getElementById("canvas_rotation_value_txt").value = this.value;
            });

    g.append("input")
        .attr("class", "without_spinner")
        .attr("id", "canvas_rotation_value_txt")
        .attrs({value: 0, min: 0, max: 360, step: "any"})
        .styles({width: "30px", "margin-left": "10px"})
        .on("change", function(){
            rotate_global(this.value);
            document.getElementById("form_rotate").value = this.value;
        });

    g.append("span")
        .html("°");

    let background = map.append("g")
                        .attrs({id: "Simplified_land_polygons", class: "layer"})
                        .style("stroke-width", "0.3px");

    d3.json("/static/data_sample/simplified_land_polygons.topojson", function(error, json) {
        background.selectAll('.subunit')
                  .data(topojson.feature(json, json.objects.simplified_land_polygons).features)
                  .enter()
                  .append('path')
                  .attr("d", path)
                  .styles({stroke: "rgb(0,0,0)", fill: "lightgrey", "stroke-opacity": 0.0, "fill-opacity": 0.75});
        map.selectAll(".layer").selectAll("path").attr("d", path);
        current_layers["Simplified_land_polygons"] = {
            "type": "Polygon", "n_features":125,
            "stroke-width-const": 0.3, "fill_color": {single: "#d3d3d3"}
        };
        scale_to_lyr("Simplified_land_polygons");
        center_map("Simplified_land_polygons");
        zoom_without_redraw();
    });

    let section5b = d3.select("#section5");
    let dv5b = section5b.append("div")
                .attr("class", "form-item");

    let type_export = dv5b.append("p");
    type_export.append("span").attr("class", "i18n")
            .attr("data-i18n", "[html]app_page.section5b.type");
    let select_type_export = type_export.append("select")
            .attr("id", "select_export_type")
            .styles({"margin": "0px 0px 0px 3px"})
            .on("change", function(){
                let type = this.value;
                if(type === "svg"){
                    document.getElementById("export_options_png").style.display = "none";
                    let export_filename = document.getElementById("export_filename");
                    export_filename.value = "export.svg";
                    export_filename.style.display = "";
                    export_filename.previousSibling.style.display = "";
                    document.getElementById("export_button_section5b").innerHTML = i18next.t("app_page.section5b.export_button");
                } else if (type === "png"){
                    document.getElementById("export_options_png").style.display = "";
                    let export_filename = document.getElementById("export_filename");
                    export_filename.value = "export.png";
                    export_filename.style.display = "";
                    export_filename.previousSibling.style.display = "";
                    document.getElementById("export_button_section5b").innerHTML = i18next.t("app_page.section5b.export_button");
                } else if (type === "geo"){
                    document.getElementById("export_button_section5b").innerHTML = i18next.t("app_page.section5b.next");
                    document.getElementById("export_options_png").style.display = "none";
                    let export_filename = document.getElementById("export_filename");
                    export_filename.style.display = "none";
                    export_filename.previousSibling.style.display = "none";
                }
            });

    select_type_export.append("option").text("Svg").attr("value", "svg");
    select_type_export.append("option").text("Png").attr("value", "png");
    select_type_export.append("option").text("Geo").attr("value", "geo");

    let export_png_options = dv5b.append("p")
                                .attr("id", "export_options_png")
                                .style("display", "none");
    export_png_options.append("span")
            .attrs({"class": "i18n", "data-i18n": "[html]app_page.section5b.format"});

    let select_size_png = export_png_options.append("select").attr("id", "select_png_format");
    select_size_png.append("option").text("Web").attr("value", "web");
    select_size_png.append("option").attrs({value: "user_defined", class: "i18n", "data-i18n": "[text]app_page.section5b.user_defined"});
    select_size_png.append("option").attrs({value: "A5_landscape", class: "i18n", "data-i18n": "[text]app_page.section5b.A5_landscape"});
    select_size_png.append("option").attrs({value: "A5_portrait", class: "i18n", "data-i18n": "[text]app_page.section5b.A5_portrait"});
    select_size_png.append("option").attrs({value: "A4_landscape", class: "i18n", "data-i18n": "[text]app_page.section5b.A4_landscape"});
    select_size_png.append("option").attrs({value: "A4_portrait", class: "i18n", "data-i18n": "[text]app_page.section5b.A4_portrait"});
    select_size_png.append("option").attrs({value: "A3_landscape", class: "i18n", "data-i18n": "[text]app_page.section5b.A3_landscape"});
    select_size_png.append("option").attrs({value: "A3_portrait", class: "i18n", "data-i18n": "[text]app_page.section5b.A3_portrait"});


    select_size_png.on("change", function(){
        let value = this.value,
            unit = value === "web" ? "px" : "cm",
            in_h = document.getElementById("export_png_height"),
            in_w = document.getElementById("export_png_width");
        if(value === "web"){
            in_h.value = h;
            in_w.value = w;
        } else if (value === "user_defined"){
            in_h.value = Math.round(h / 118.11 * 10) / 10;
            in_w.value = Math.round(w / 118.11 * 10) / 10
        } else if (value === "A4_landscape"){
            in_h.value = 21.0;
            in_w.value = 29.7;
        } else if (value === "A4_portrait"){
            in_h.value = 29.7;
            in_w.value = 21.0;
        } else if (value === "A3_landscape"){
            in_h.value = 42.0;
            in_w.value = 29.7;
        } else if (value === "A3_portrait"){
            in_h.value = 29.7;
            in_w.value = 42.0;
        } else if (value === "A5_landscape"){
            in_h.value = 14.8;
            in_w.value = 21.0;
        } else if (value === "A5_portrait"){
            in_h.value = 21.0;
            in_w.value = 14.8;
        }
        document.getElementById("export_png_width_txt").innerHTML = unit;
        document.getElementById("export_png_height_txt").innerHTML = unit;
        if(value.indexOf("portrait") > -1 || value.indexOf("landscape") > -1){
            in_h.disabled = "disabled";
            in_w.disabled = "disabled";
        } else {
            in_h.disabled = undefined;
            in_w.disabled = undefined;
        }
        console.log(in_w)
    })

    let exp_a = export_png_options.append("p");
    exp_a.append("span")
            .attrs({"class": "i18n", "data-i18n": "[html]app_page.section5b.height"});

    exp_a.append("input")
            .style("width", "60px")
            .attrs({"id": "export_png_height", "type": "number", step: 0.1, value: h})
            .on("change", function(){
                let ratio = h / w,
                    export_png_width = document.getElementById("export_png_width");
                export_png_width.value = Math.round(+this.value / ratio * 10) / 10;
            });

    exp_a.append("span")
            .attr("id", "export_png_height_txt")
            .html("px");

    let exp_b = export_png_options.append("p");
    exp_b.append("span")
            .attrs({"class": "i18n", "data-i18n": "[html]app_page.section5b.width"});

    exp_b.append("input")
            .style("width", "60px")
            .attrs({"id": "export_png_width", "type": "number", step: 0.1, value: w})
            .on("change", function(){
                let ratio = h / w,
                    export_png_height = document.getElementById("export_png_height");
                export_png_height.value = Math.round(+this.value * ratio * 10) / 10;
            });

    exp_b.append("span")
            .attr("id", "export_png_width_txt")
            .html("px");

    let export_geo_options = dv5b.append("p")
                                .attr("id", "export_options_geo")
                                .style("display", "none");

    let selec_layer = export_geo_options.append("p").html(i18next.t("app_page.export_box.option_layer"))
             .insert("select").attr("id", "layer_to_export");

    let selec_type = export_geo_options.append("p").html(i18next.t("app_page.export_box.option_datatype"))
             .insert("select").attr("id", "datatype_to_use");

    let selec_projection = export_geo_options.append("p").html(i18next.t("app_page.export_box.option_projection"))
             .insert("select").attr("id", "projection_to_use");

    let proj4_input = export_geo_options.append("input")
                                .attr("id", "proj4str")
                                .style("display", "none")
                                .style("width", "200px");

    ["GeoJSON", "TopoJSON", "ESRI Shapefile", "GML", "KML"].forEach( name => {
        selec_type.append("option").attr("value", name).text(name);
    });

    [["Geographic coordinates / WGS84 (EPSG:4326)", "epsg:4326"],
     ["Web-mercator / WGS84 (EPSG:3857)", "epsg:3857"],
     ["LAEA Europe / ETRS89 (EPSG:3035)", "epsg:3035"],
     ["USA Albers Equal Area / NAD83", "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"],
     ["British National Grid / OSGB36 (EPSG:27700)", "epsg:27700"],
     ["Lambert-93 / RGF93-GRS80 (EPSG:2154)", "epsg:2154"],
     ["Eckert IV / WGS84", "+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "],
     ["Enter any valid Proj.4 string...", "proj4string"]].forEach(projection => {
        selec_projection.append("option").attr("value", projection[1]).text(projection[0]);
    });

    selec_type.on("change", function(){
        if(this.value == "TopoJSON" || this.value == "KML"){
            selec_projection.node().options.selectedIndex = 0;
            selec_projection.attr("disabled", true);
        } else {
            selec_projection.attr("disabled", null);
        }
    });

    selec_projection.on("change", function(){
        if(this.value == "proj4string")
            proj4_input.style("display", "initial");
        else
            proj4_input.style("display", "none");
    });

    let export_name = dv5b.append("p");
    export_name.append("span")
            .attrs({class: "i18n", "data-i18n": "[html]app_page.section5b.filename"});

    export_name.append("input")
            .attr("id", "export_filename");

    dv5b.append("button")
            .attrs({"id": "export_button_section5b", "class": "i18n button_st4", "data-i18n": "[html]app_page.section5b.export_button"})
            .on("click", function(){
                let type_export = document.getElementById("select_export_type").value,
                    export_name = document.getElementById("export_filename").value;
                if(type_export === "svg"){
                    export_compo_svg(export_name);
                } else if (type_export === "geo"){
                    make_export_layer_box()
                    /*
                    let layer = document.getElementById("layer_to_export").value,
                        type_format = document.getElementById("datatype_to_use").value,
                        projection = document.getElementById("projection_to_use").value,
                        proj4string = document.getElementById("proj4str").value;
                    export_layer_geo(layer, type_format, projection, proj4string);
                    */
                } else if (type_export === "png"){
                    let type_export = document.getElementById("select_png_format").value,
                        ratio;
                    if(type_export === "web"){
                        ratio = +document.getElementById("export_png_height").value / +h;
                    } else {
                        type_export = "paper";
                        ratio = (+document.getElementById("export_png_height").value * 118.11) / +h;
                    }
                    _export_compo_png(type_export, ratio, export_name);
                }
            });

    let const_options = d3.select(".header_options").append("div").attr("id", "const_options").style("display", "inline");

    let rotation_param = const_options.append("span");

    rotation_param.append("input")
            .attrs({type: "range", id: "form_projection_center", value: 0.0,
                    min: -180.0, max: 180.0, step: 0.1})
            .styles({width: "120px", margin: "0px", "vertical-align": "sub"})
            .on("input", function(){
                handle_proj_center_button([this.value, null, null]);
                document.getElementById("proj_center_value_txt").value = +this.value;
            });
    rotation_param.append("input")
            .attrs({type: "number", class: "without_spinner", id: "proj_center_value_txt",
                    min: -180.0, max: 180.0, value: 0, step: "any"})
            .styles({width: "38px", "margin": "0 10px",
                     "color": " white", "background-color": "#173a50",
                     "vertical-align": "calc(20%)"})
            .on("change", function(){
                handle_proj_center_button([this.value, null, null]);
                document.getElementById("form_projection_center").value = this.value;
            });
    rotation_param.append("span")
            .style("vertical-align", "calc(20%)")
            .html("°");

/*
    projection_menu.append("div")
            .style("text-align", "center")
            .insert("button")
            .attr("id","reset_center_rotation")
            .attr("class", "button_st4 i18n")
            .attr("data-i18n", "[html]app_page.section5.reset")
            .on("click", function(){
                // Todo : improve the behavior of this button
                // Reset the rotation :
                proj.scale(0).translate(0,0);
                document.getElementById('form_projection_center').value = 0;
                document.getElementById('form_rotate').value = 0;
                document.getElementById('proj_center_value_txt').value = 0;
                proj.rotate([0,,]);
                reproj_symbol_layer();
                rotate_global(0);

                // Reset the projection :
                setSelected(document.getElementById("form_projection"), document.getElementById("form_projection").options[0].value);
                let layer_name = Object.getOwnPropertyNames(user_data)[0] || Object.getOwnPropertyNames(result_data)[0] || null;
                if(layer_name){
                    center_map(layer_name);
                    zoom_without_redraw();
                } else {
                    svg_map.__zoom = d3.zoomIdentity.scale(0.5).translate(400, 250);
                    zoom_without_redraw();
                }
            });
*/
    let proj_select = const_options.append("select")
                .attr("id","form_projection")
                .styles({"align": "center", "color": " white", "background-color": "#173a50", "border": "none"})
                .on("change", function(){
                    current_proj_name = this.selectedOptions[0].textContent;
                    change_projection(this.value);
                });
    d3.json("/static/json/projections.json", function(json) {
       json.forEach(function(d) {
            available_projections.set(d.name, d.projection);
            proj_select.append("option").text(d.name).attr("value", d.projection);
           });
        if(resume_project){
            // Fetch the last snapchot in localStorage :
            var json_params = window.localStorage.getItem("noname_map_project");

            // Apply the preferences :
            if(json_params){
                apply_user_preferences(json_params);
            }
        } else {
            // If we don't want to resume from the last project, we can
            // remove it :
            window.localStorage.removeItem("noname_app_project");
        }
    });

    const_options.append("button")
              .attrs({class: "const_buttons", id: "export_btn",
                      title: "Export / Load your map preferences"})
              .styles({cursor: "pointer", background: "transparent", "margin-top": "none"})
              .html('<img src="/static/img/Wikiversity-Mooc-Icon-Download_modif_blank.png" width="20" height="20" alt="export_load_preferences"/>')
              .on("click", function(){
                    if(document.getElementById("menu_pref")) {
                        document.getElementById("menu_pref").remove();
                        return;
                    } else {
                        if(document.getElementById("menu_lang"))
                            document.getElementById("menu_lang").remove();

                        let actions = [
                            {"name": i18next.t("app_page.common.save_project_json"), "callback": save_map_template},
                            {"name": i18next.t("app_page.common.load_project_json"), "callback": load_map_template}
                            ];
                        let menu = document.createElement("div");
                        menu.style.top = "30px";
                        menu.style.right = "38px";
                        menu.style.background = "#173a50";
                        menu.className = "context-menu";
                        menu.id = "menu_pref";
                        let list_elems = document.createElement("ul");
                        menu.appendChild(list_elems);
                        for (let i = 0; i < actions.length; i++) {
                            let item = document.createElement("li");
                            list_elems.appendChild(item);
                            item.setAttribute("data-index",i);
                            let name = document.createElement("span");
                            name.className = "context-menu-item-name";
                            name.textContent = actions[i].name;
                            item.appendChild(name);
                            item.onclick = function(){
                                actions[i].callback();
                                menu.remove();
                            }
                        }
                        document.querySelector("body").appendChild(menu);
                    }
                });

    const_options.append("button")
              .attrs({id: "help_btn", class: "const_buttons", title: "help"})
              .styles({cursor: "pointer", background: "transparent", "margin-top": "none"})
              .html('<img src="/static/img/High-contrast-help-browser_blank.png" width="18" height="18" alt="export_load_preferences"/>')
              .on("click", function(){
                  if(document.getElementById("menu_lang"))
                      document.getElementById("menu_lang").remove();
                  if(document.getElementById("menu_pref"))
                      document.getElementById("menu_pref").remove();
                  swal({
                      title: i18next.t("app_page.help_box.title"),
                      text: i18next.t("app_page.help_box.message_invite"),
                      input: "text",
                      showCancelButton: true,
                      animation: "slide-from-top",
                      inputPlaceholder: i18next.t("app_page.help_box.list_placeholders")
                   }).then(inputValue => {
                          swal("Nice!", "You wrote: " + inputValue, "success");
                        }, dismissValue => { null; });
                });

    const_options.append("button")
        .attrs({id: "current_app_lang", class: "const_buttons"})
        .styles({color: "white",
                 "font-size": "14px", "vertical-align": "super",
                 background: "transparent", "font-weight": "bold"})
        .html(i18next.language)
        .on("click", function(){
            if(document.getElementById("menu_lang"))
                document.getElementById("menu_lang").remove();
            else {
                if(document.getElementById("menu_pref"))
                    document.getElementById("menu_pref").remove();
                let current_lang = i18next.language;
                let other_lang = current_lang == "en" ? "fr" : "en"
                let actions = [
                    {"name": current_lang, "callback": change_lang},
                    {"name": other_lang, "callback": change_lang}
                    ];
                let menu = document.createElement("div");
                menu.style.top = "30px";
                menu.style.right = "0px";
                menu.className = "context-menu";
                menu.id = "menu_lang";
                menu.style.minWidth = "30px";
                menu.style.width = "50px";
                menu.style.background = "#173a50";
                let list_elems = document.createElement("ul");
                menu.appendChild(list_elems);
                for (let i = 0; i < actions.length; i++) {
                    let item = document.createElement("li"),
                        name = document.createElement("span");
                    list_elems.appendChild(item);
                    item.setAttribute("data-index", i);
                    item.style.textAlign = "right";
                    item.style.paddingRight = "16px";
                    name.className = "context-menu-item-name";
                    name.style.color = "white";
                    name.textContent = actions[i].name;
                    item.appendChild(name);
                    item.onclick = () => {
                        actions[i].callback();
                        menu.remove();
                    };
                }
                document.querySelector("body").appendChild(menu);
            }
        });

    // Zoom-in, Zoom-out, Info, Hand-Move and RectZoom buttons (on the top of the map) :
    let lm = map_div
                .append("div")
                .attr("class", "light-menu")
                .styles({position:"absolute", right:"0px", bottom: "0px"});

    let lm_buttons = [
        {id: "zoom_out", "i18n": "[tooltip-title]app_page.lm_buttons.zoom-", class: "zoom_button i18n", html: "-"},
        {id: "zoom_in", "i18n": "[tooltip-title]app_page.lm_buttons.zoom+", class: "zoom_button i18n", html: "+"},
        {id: "info_button", "i18n": "[tooltip-title]app_page.lm_buttons.i", class: "info_button i18n", html: "i"},
        {id: "hand_button", "i18n": "[tooltip-title]app_page.lm_buttons.hand_button", class: "hand_button active i18n", html: '<img src="/static/img/Closed_Hand_thenounproject_blank.png" width="18" height="18" alt="Hand_closed"/>'}/*,
        {id: "brush_zoom_button", class: "brush_zoom_button", "i18n": "[tooltip-title]app_page.lm_buttons.zoom_rect", html: '<img src="/static/img/Inkscape_icons_zoom_fit_selection_blank.svg" width="18" height="18" alt="Zoom_select"/>'}*/
    ];

    let selec = lm.selectAll("input")
        .data(lm_buttons).enter()
        .append('p').style("margin", "auto")
            .insert("button")
            .attr("class", d => d.class)
            .attr("data-i18n", d => d.i18n)
            .attr("id", d => d.id)
            .html(d => d.html);

    // Trigger actions when buttons are clicked and set-up the initial view :
    d3.selectAll(".zoom_button").on("click", zoomClick);
    document.getElementById("info_button").onclick = displayInfoOnMove;
    document.getElementById("hand_button").onclick = handle_click_hand;
    document.getElementById("hand_button").style = "box-shadow: 2px 2px 1px black inset;";
    //document.getElementById("brush_zoom_button").onclick = brush_rect;

    // Already append the div for displaying information on features,
    // setting it currently unactive until it will be requested :
    d3.select("body").append("div")
                  .attr("id", "info_features")
                  .classed("active", false)
                  .style("display", "none")
                  .html("");

    create_li_layer_elem("Simplified_land_polygons", null, "Polygon", "sample");
    prepare_drop_section();
    accordionize(".accordion");
    new Sortable(document.getElementById("sortable"), {
        animation: 100,
        onUpdate: function(a){
          // Set the layer order on the map in concordance with the user changes
          // in the layer manager with a pretty rusty 'sorting' algorythm :
          let at_end = null;
          if(document.getElementById("info_features").className == "active"){
            displayInfoOnMove();
            at_end = true;
          }
          let desired_order = [],
              actual_order = [],
              layers = svg_map.querySelectorAll(".layer");

          for(let i=0, len_i = a.target.childNodes.length; i < len_i; i++){
              let n = a.target.childNodes[i].getAttribute("layer_name");
              desired_order[i] = n;
              actual_order[i] = layers[i].id;
          }
          for(let i = 0, len = desired_order.length; i < len; i++){
              let lyr1 = document.getElementById(desired_order[i]),
                  lyr2 = document.getElementById(desired_order[i+1]) || document.getElementById(desired_order[i]);
              svg_map.insertBefore(lyr2, lyr1);
          }
         if(at_end) displayInfoOnMove();
        },
        onStart: event => {
            document.body.className = document.body.className + " no-drop";
        },
        onEnd: event => {
            document.body.className = document.body.className.replace("no-drop", "");
        },
    })
}

function bindTooltips(){
    // bind the mains tooltips
    let existing_tooltips = document.querySelectorAll(".bs_tooltip");
    for(let i = existing_tooltips.length - 1; i > -1; i--){
        existing_tooltips[i].remove();
    }
    let tooltips_elem = document.querySelectorAll("[tooltip-title]");
    for(let i = tooltips_elem.length - 1; i > -1; i--){
        new Tooltip(tooltips_elem[i], {
            dataAttr: "tooltip-title",
            animation: "slideNfade",
            duration: 50,
            delay: 100,
            container: document.getElementById("twbs")
        });
    }
}


function make_eye_button(state){
    if(state == "open"){
        let eye_open = document.createElement("img");
        eye_open.setAttribute("src", "/static/img/b/eye_open.svg");
        eye_open.setAttribute("class", "active_button i18n")
        eye_open.setAttribute("id", "eye_open");
        eye_open.setAttribute("width", 17);
        eye_open.setAttribute("height", 17);
        eye_open.setAttribute("alt", "Visible");
        //eye_open.setAttribute("data-i18n", "[title]app_page.common.eye_open");
        //eye_open.setAttribute("title", i18next.t("app_page.common.eye_open"));
        return eye_open;
    } else if (state == "closed"){
        let eye_closed = document.createElement("img");
        eye_closed.setAttribute("src", "/static/img/b/eye_closed.svg");
        eye_closed.setAttribute("class", "active_button i18n");
        eye_closed.setAttribute("id", "eye_closed");
        eye_closed.setAttribute("width", 17);
        eye_closed.setAttribute("height", 17);
        eye_closed.setAttribute("alt", "Not visible");
        //eye_closed.setAttribute("data-i18n", "[title]app_page.common.eye_closed");
        //eye_closed.setAttribute("title", i18next.t("app_page.common.eye_closed"));
        return eye_closed;
    }
}

function change_lang(){
    let new_lang = this.name;
    if(new_lang == i18next.language){
        return;
    } else {
        let other_lang = new_lang == "fr" ? "en" : "fr";
        i18next.changeLanguage(new_lang, () => {
            localize(".i18n");
            bindTooltips();
        });
        document.getElementById("current_app_lang").innerHTML = new_lang;
        let menu = document.getElementById("menu_lang");
        if(menu)
            menu.remove();
    }
}


function make_ico_choice(){
    let list_fun_ico = ['icon_prop.png',
                        'icon_choro.png',
                        'icon_typo.png',
                        'icon_choroprop.png',
                        'icon_flow.png',
                        'icon_grid.png',
                        'icon_cartogram.png',
                        'icon_smooth.png',
                        'icon_discont.png',
                        'icon_typosymbol.png',
                        'icon_proptypo.png',
                        'icon_label.png'];
    let function_panel = section2_pre.append("div")
                            .attr("id", "list_ico_func");

    for(let i = 0, len_i = list_fun_ico.length; i < len_i; i++){
        let ico_name = list_fun_ico[i],
            func_name = ico_name.split('.')[0].split("_")[1],
            func_desc = get_menu_option(func_name).desc;
        function_panel
            .insert("img")
            .styles({"float": "left", "list-style": "none"})
            .attr("class", "i18n")
            .attr("data-i18n", ["[title]app_page.func_description.", func_name].join(''))
            .attr("src", ["/static/img/func_icons/", ico_name].join(''))
            .attr("id", "button_" + func_name)
            .style("margin", "1px")
            .style("cursor", "pointer")
            .style("width", "50px")
            .on("click", function(){
                // Do some clean-up related to the previously displayed options :
                if(window.fields_handler){
                    fields_handler.unfill();
                    let previous_button = document.getElementById("button_" + current_functionnality.name);
                    previous_button.style.filter = "invert(0%) saturate(100%)";
                    previous_button.style.boxShadow = "";
                    clean_menu_function();
                }

                // Highlight the icon of the selected functionnality :
                this.style.filter = "invert(100%) saturate(200%)";
                this.style.boxShadow = "-1px 1px 5px 2px #888888";

                // Get the function to fill the menu with the appropriate options (and do it):
                current_functionnality = get_menu_option(func_name);
                let make_menu = eval(current_functionnality.menu_factory);
                window.fields_handler = eval(current_functionnality.fields_handler);
                make_menu();

                // Replace the title of the section:
                let selec_title = document.getElementById("btn_s2");
                selec_title.innerHTML = '<span class="i18n" data-i18n="app_page.common.representation">' +
                                        i18next.t("app_page.common.representation") +
                                        '</span><span> : </span><span class="i18n" data-i18n="app_page.func_title.' +
                                        current_functionnality.name +
                                        '">' +
                                        i18next.t("app_page.func_title."+ current_functionnality.name) +
                                        '</span>';

                // Bind the help tooltip (displayed when mouse over the 'i' icon) :
                let btn_info = document.getElementById("btn_info");
                btn_info.setAttribute("data-title", i18next.t("app_page.func_help." + func_name + ".title"));
                btn_info.setAttribute("data-content", i18next.t("app_page.func_help." + func_name + ".block"));
                new Popover(btn_info,{
                    container: document.getElementById("twbs"),
                    customClass: "help-popover",
                    dismiss: "true",
                    dismissOutsideClick: true,
                    placement: "right"
                });

                // Fill the field of the functionnality with the field
                // of the targeted layer if already uploaded by the user :
                if(targeted_layer_added){
                    let target_layer = Object.getOwnPropertyNames(user_data)[0];
                    fields_handler.fill(target_layer);
                }

                // Specific case for flow/link functionnality as we are also
                // filling the fields with data from the uploaded tabular file if any :
                if(func_name == "flow" && joined_dataset){
                    fields_handler.fill();
                }
            });
    }
    section2_pre.append("hr")
            .styles({"clear": "both", "position": "relative"});
}

var w = Math.round(window.innerWidth - 360),
    h = window.innerHeight - 45;

var existing_lang = ["en", "fr"];

var proj = d3.geoNaturalEarth().scale(1).translate([0,0]);

var path = d3.geoPath().projection(proj).pointRadius(4),
    t = proj.translate(),
    s = proj.scale(),
    current_proj_name = "Natural Earth",
    available_projections = new Map(),
    zoom = d3.zoom().on("zoom", zoom_without_redraw),
    sample_no_values = new Set(["Sphere", "Graticule", "Simplified_land_polygons"]);

/*
A bunch of global variable, storing oftently reused informations :
    - user_data[layer_name] : will be an Array of Objects containing data for each features of the targeted layer
            (+ the joined features if a join is done)
    - result_data[layer_name] : the same but for any eventual result layers (like Stewart, gridded, etc.)
    - joined_dataset : the joined dataset (read with d3.csv then pushed in the first slot of this array)
    - field_join_map : an array containg mapping between index of geom layer and index of ext. dataset
    - current_layers : the main object describing **all** the layers on the map (incunding detailed (ie. by features) styling properties if needed)
*/

var user_data = new Object(),
    result_data = new Object(),
    joined_dataset = [],
    field_join_map  = [],
    targeted_layer_added = false,
    current_layers = new Object(),
    dataset_name = undefined,
    canvas_rotation_value = undefined,
    map_div = d3.select("#map"),
    current_functionnality = undefined;

// The "map" (so actually the `map` variable is a reference to the main `svg` element on which we are drawing)
var map = map_div.style("width", w+"px").style("height", h+"px")
            .append("svg")
                .attr("id", "svg_map")
                .attr("width", w)
                .attr("height", h)
                .style("position", "absolute")
                .call(zoom);

var defs = map.append("defs");


// A bunch of references to the buttons used in the layer manager
// and some mapping to theses reference according to the type of geometry :
const button_trash = ' <img src="/static/img/Trash_font_awesome.png" id="trash_button" class="i18n" width="15" height="15" alt="submit" data-i18n="[title]app_page.common.trash"/>',
    button_legend = ' <img src="/static/img/qgis_legend.png" id="legend_button" class="i18n" width="17" height="17" alt="submit" data-i18n="[title]app_page.common.legend"/>',
    button_zoom_fit = ' <img src="/static/img/Inkscape_icons_zoom_fit_page.png" class="i18n" id="zoom_fit_button" width="16" height="16" alt="submit" data-i18n="[title]app_page.common.zoom_fit"/></button>',
    button_type = new Map([
        ["Point", '<img src="/static/img/type_geom/dot.png" class="ico_type" width="17" height="17" alt="Point"/>'],
        ["Line", '<img src="/static/img/type_geom/line.png" class="ico_type" width="17" height="17" alt="Line"/>'],
        ["Polygon", '<img src="/static/img/type_geom/poly.png" class="ico_type" width="17" height="17" alt="Polygon"/>']
        ]);

const button_result_type = new Map([
        ["flow", '<img src="/static/img/type_geom/layer_flow.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["symbol", '<img src="/static/img/type_geom/layer_symbol.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["grid", '<img src="/static/img/type_geom/layer_grid.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["MTA", '<img src="/static/img/type_geom/layer_mta.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["propchoro", '<img src="/static/img/type_geom/layer_propchoro.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["typo", '<img src="/static/img/type_geom/layer_typo.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["discont", '<img src="/static/img/type_geom/layer_disc.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["cartogram", '<img src="/static/img/type_geom/layer_cartogram.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["label", '<img src="/static/img/type_geom/layer_label.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["choro", '<img src="/static/img/type_geom/layer_choro.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["smooth", '<img src="/static/img/type_geom/layer_smooth.svg" class="ico_type" width="17" height="17" alt="Polygon"/>'],
        ["prop", '<img src="/static/img/type_geom/layer_prop.svg" class="ico_type" width="17" height="17" alt="Polygon"/>']
        ]);

const eye_open0 = '<img src="/static/img/b/eye_open.svg" class="active_button" id="eye_open"  width="17" height="17" alt="Visible"/>';

// Reference to the sys run button already in two requested sizes are they are called many times :
const sys_run_button = '<img src="/static/img/High-contrast-system-run.svg" width="22" height="22" style="vertical-align: inherit;" alt="submit"/>',
      sys_run_button_t2 = '<img src="/static/img/High-contrast-system-run.svg" class="style_target_layer" width="18" height="18" alt="Layer_rendering" style="float:right;"/>';

// Shortcut to the name of the methods offered by geostats library:
const discretiz_geostats_switch = new Map([
        ["jenks", "getJenks"],
        ["equal_interval", "getEqInterval"],
        //["std_dev", "getStdDeviation"],
        ["quantiles", "getQuantile"],
        ["arithmetic_progression", "getArithmeticProgression"],
        ["Q6", "getBreaksQ6"],
        ["geometric_progression", "getGeometricProgression"]
    ]);

// Reference to the availables fonts that the user could select :
const available_fonts = [
    ['Arial', 'Arial,Helvetica,sans-serif'],
    ['Arial Black', 'Arial Black,Gadget,sans-serif'],
    ['Arimo', 'Arimo,sans-serif'],
    ['Baloo Bhaina', 'Baloo Bhaina,sans-serif'],
    ['Bitter', 'Bitter,sans-serif'],
    ['Dosis', 'Dosis,sans-serif'],
    ['Humor Sans', 'Humor Sans'],
    ['Roboto', 'Roboto,sans-serif'],
    ['Lobster', 'Lobster,sans-serif'],
    ['Impact', 'Impact,Charcoal,sans-serif'],
    ['Inconsolata', 'Inconsolata,sans-serif'],
    ['Georgia', 'Georgia,serif'],
    ['Lobster', 'Lobster,serif'],
    ['Lucida', 'Lucida Sans Unicode,Lucida Grande,sans-serif'],
    ['Palatino', 'Palatino Linotype,Book Antiqua,Palatino,serif'],
    ['Roboto', 'Roboto'],
    ['Scope One', 'Scope One'],
    ['Tahoma', 'Tahoma,Geneva,sans-serif'],
    ['Trebuchet MS', 'Trebuchet MS, elvetica,sans-serif'],
    ['Verdana', 'Verdana,Geneva,sans-serif']
    ];

// This variable have to be (well, we could easily do this in an other way!) up to date
// with the style-fonts.css file as we are using their order to lookup for their definition
// the .css file.
const customs_fonts = ['Arimo', 'Baloo Bhaina', 'Bitter', 'Dosis', 'Inconsolata', 'Lobster', 'Roboto', 'Scope One'];

{% raw %}

(function(){
    let lang = window.navigator.language.split('-')[0],
        resume_project = false;


    if(window.location.search){
        let old_url = window.location.search;
        if(old_url.indexOf("?lang=") > -1){
            lang = old_url.split("?lang=");
            lang = lang[lang.length - 1].trim();
        }

        if(old_url.indexOf("?resume") > -1){
            resume_project = true;
        }

        if (typeof (history.pushState) != "undefined") {
            var obj = {Page: window.location.search, Url: window.location.pathname};
            history.pushState(obj, obj.Page, obj.Url);
        }
    }

    lang = existing_lang.indexOf(lang) > -1 ? lang : 'en';
    i18next.use(i18nextXHRBackend)
      .init({
          debug: true,
          lng: lang,
          fallbackLng: existing_lang[0],
          backend: {
            loadPath: "/static/locales/{{lng}}/translation.json"
          }
    }, (err, t) => {
        if(err)
            throw err;
        else {
            window.localize = locI18next.init(i18next);
            setUpInterface(resume_project);
            localize(".i18n");
            bindTooltips();
        }
    });
})();

{% endraw %}

function up_legends(){
    let legend_features = svg_map.querySelectorAll('.legend');
    for(let i = 0; i < legend_features.length; i++){
        svg_map.appendChild(legend_features[i], null);
    }
}

////////////////
// To sort:
////////////////

// To bind the set of small buttons (trash icon, paint icon, active/deactive visibility, info tooltip, etc..)
// which are on each feature representing a layer in the layer manager
// (the function is called each time that a new feature is put in this layer manager)
function binds_layers_buttons(layer_name){
    if(layer_name == undefined){
        alert("This shouldn't happend");
        return;
    }
    let sortable_elem = d3.select("#sortable").select("." + layer_name);
    sortable_elem.on("dblclick", () => { handle_click_layer(layer_name); });
    sortable_elem.on("contextmenu", () => { d3.event.preventDefault(); return; });
    sortable_elem.select("#trash_button").on("click", () => { remove_layer(layer_name); });
    sortable_elem.select(".active_button").on("click", () => { handle_active_layer(layer_name); });
    sortable_elem.select(".style_button").on("click", () => { handle_click_layer(layer_name); });
    sortable_elem.select(".style_target_layer").on("click", () => { handle_click_layer(layer_name) });
    sortable_elem.select("#legend_button").on("click", () => { handle_legend(layer_name); });
    sortable_elem.select("#zoom_fit_button").on("click", () => {
        center_map(layer_name);
        zoom_without_redraw();
    });

    //$("[layer-tooltip!='']").qtip({
    //    content: { attr: "layer-tooltip" },
    //    style: { classes: 'qtip-rounded qtip-light qtip_layer'}
    //});
}

// Function to display information on the top layer (in the layer manager)
// it will only works on layers appearing in blue in the layer manager
// (ie. the targeted layer and result(s?) layer(s?))
function displayInfoOnMove(){
    var info_features = d3.select("#info_features");
    if(info_features.classed("active")){
        d3.select(".info_button").style('box-shadow', null);
        map.selectAll(".layer").selectAll("path").on("mouseover", null);
        map.selectAll(".layer").selectAll("circle").on("mouseover", null);
        map.selectAll(".layer").selectAll("rect").on("mouseover", null);
        info_features.classed("active", false);
        info_features.node().innerHTML = "";
        info_features.style("display", "none");
        document.getElementById("map").style.cursor="";
    } else {
        let layers = document.querySelectorAll(".layer"),
            nb_layer = layers.length,
            top_visible_layer = null;

        for(let i = nb_layer-1; i > -1; i--){
            if(layers[i].style.visibility != "hidden"){
                top_visible_layer = layers[i].id
                break;
            }
        }

        if(!top_visible_layer){
            swal("", i18next.t("app_page.common.error_no_visible"), "error");
            return;
        }

        let id_top_layer = "#" + top_visible_layer,
            symbol = current_layers[top_visible_layer].symbol;

        d3.select(".info_button").style('box-shadow', 'inset 2px 2px 1px black');
        if(symbol){
            let ref_layer_name = current_layers[top_visible_layer].ref_layer_name;
            map.select(id_top_layer).selectAll(symbol).on("mouseover", function(d,i){
                let txt_info = ["<h3>", top_visible_layer, "</h3><i>Feature ",
                                i + 1, "/", current_layers[top_visible_layer].n_features, "</i><p>"];
                let properties = result_data[top_visible_layer][i];
                Object.getOwnPropertyNames(properties).forEach(function(el, i){
                    txt_info.push("<br><b>"+el+"</b> : "+properties[el]);
                    });
                txt_info.push("</p>");
                info_features.node().innerHTML = txt_info.join('');
                info_features.style("display", null);
                });
        } else {
            symbol = "path"
            map.select(id_top_layer).selectAll("path").on("mouseover", function(d,i){
                let txt_info = ["<h3>", top_visible_layer, "</h3><i>Feature ",
                                i + 1, "/", current_layers[top_visible_layer].n_features, "</i><p>"];
                Object.getOwnPropertyNames(d.properties).forEach(function(el, i){
                    txt_info.push("<br><b>"+el+"</b> : "+d.properties[el]);
                    });
                txt_info.push("</p>");
                info_features.node().innerHTML = txt_info.join('');
                info_features.style("display", null);
                });
        }
        map.select(id_top_layer).selectAll(symbol).on("mouseout", function(){
                info_features.node().innerHTML = "";
                info_features.style("display", "none");
        });
        info_features.classed("active", true);
        document.getElementById("map").style.cursor="help";
    }
}


function reproj_symbol_layer(){
  for(let lyr_name in current_layers){
    if(current_layers[lyr_name].renderer
        && (current_layers[lyr_name].renderer.indexOf('PropSymbol') > -1
            || current_layers[lyr_name].renderer.indexOf('TypoSymbols')  > -1
            || current_layers[lyr_name].renderer.indexOf('Label')  > -1 )){
      let ref_layer_name = current_layers[lyr_name].ref_layer_name,
          features_order = current_layers[lyr_name].features_order,
          symbol = current_layers[lyr_name].symbol,
          new_coords = [];
      map.select("#" + ref_layer_name)
            .selectAll("path")
            .each((d,i) => {
                new_coords.push(path.centroid(d))
            });

      if (symbol == "text") {
          map.select("#"+lyr_name)
                .selectAll(symbol)
                .attr("x", (d,i) => new_coords[i][0])
                .attr("y", (d,i) => new_coords[i][1])
      } else if (symbol == "image"){
          map.select("#"+lyr_name)
                .selectAll(symbol)
                .attr("x", (d,i) => new_coords[i][0] - +this.getAttribute("width").slice(0, -2) / 2)
                .attr("y", (d,i) => new_coords[i][1] - +this.getAttribute("width").slice(0, -2) / 2)
      } else {
          let ord = features_order.map(obj => obj[0]);
          for(let i = 0; i < ord.length; i++)
            features_order[i][2] = new_coords[ord[i]];

          if(symbol == "circle")
              map.select("#"+lyr_name)
                    .selectAll(symbol)
                    .attr("cx", (d,i) => features_order[i][2][0])
                    .attr("cy", (d,i) => features_order[i][2][1])
                    .attr("r", (d,i) => features_order[i][1]);
          else if (symbol == "rect")
              map.select("#"+lyr_name)
                    .selectAll(symbol)
                    .attr("x", (d,i) => features_order[i][2][0] - features_order[i][1] / 2)
                    .attr("y", (d,i) => features_order[i][2][1] - features_order[i][1] / 2)
                    .attr("height", (d,i) => features_order[i][1])
                    .attr("width", (d,i) => features_order[i][1]);
      }
    }
  }
}

function make_dialog_container(id_box, title, class_box){
        id_box = id_box || "dialog";
        title = title || "";
        class_box = class_box || "dialog";
        let container = document.createElement("div");
        container.setAttribute("id", id_box);
        container.setAttribute("class", "twbs modal fade" + " " + class_box);
        container.setAttribute("tabindex", "-1");
        container.setAttribute("role", "dialog");
        container.setAttribute("aria-labelledby", "myModalLabel");
        container.setAttribute("aria-hidden", "true");
        container.innerHTML = '<div class="modal-dialog"><div class="modal-content"></div></div>';
        document.getElementById("twbs").appendChild(container);

        container = document.getElementById(id_box);
        let modal_box = new Modal(container, {
            content: '<div class="modal-header">'
                      +'<button type="button" id="xclose" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>'
                      +'<h4 class="modal-title" id="gridModalLabel">' + title + '</h4>'
                      +'</div>'
                      +'<div class="modal-body">'
                      +'</div>'
                      +'<div class="modal-footer">'
                      +'<button type="button" class="btn btn-default btn_ok" data-dismiss="modal">' + i18next.t("app_page.common.confirm") + '</button>'
                      +'<button type="button" class="btn btn-primary btn_cancel">' + i18next.t("app_page.common.cancel") + '</button>'
                      +'</div>'
        });
        modal_box.open();
        return modal_box;
}

var make_confirm_dialog2 = (function(class_box, title, options){
    let existing = new Set();
    let get_available_id = () => {
        for(let i = 0; i < 50; i++){
            if(!existing.has(i)){
                existing.add(i);
                return i;
            }
        }
    }
    return function(class_box, title, options){
        class_box = class_box || "dialog";
        title = title || i18next.t("app_page.common.ask_confirm");
        options = options || {};

        let container = document.createElement("div");
        let new_id = get_available_id();

        container.setAttribute("id", "myModal_" + new_id);
        container.setAttribute("class", "twbs modal fade " + class_box);
        container.setAttribute("tabindex", "-1");
        container.setAttribute("role", "dialog");
        container.setAttribute("aria-labelledby", "myModalLabel");
        container.setAttribute("aria-hidden", "true");
        container.innerHTML = options.widthFitContent ? '<div class="modal-dialog fitContent"><div class="modal-content"></div></div>'
                            : '<div class="modal-dialog"><div class="modal-content"></div></div>';
        document.getElementById("twbs").appendChild(container);

        container = document.getElementById("myModal_" + new_id);
        let deferred = Q.defer();
        let html_content = options.html_content || "";
        let text_ok = options.text_ok || i18next.t("app_page.common.confirm");
        let text_cancel = options.text_cancel || i18next.t("app_page.common.cancel");
        let modal_box = new Modal(container, {
            backdrop: true,
            content: '<div class="modal-header">'
                      +'<button type="button" id="xclose" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>'
                      +'<h4 class="modal-title" id="gridModalLabel">' + title + '</h4>'
                      +'</div>'
                      +'<div class="modal-body">'
                      +'<p>'
                      + html_content
                      +'</p>'
                      +'</div>'
                      +'<div class="modal-footer">'
                      +'<button type="button" class="btn btn-default btn_ok" data-dismiss="modal">' + text_ok + '</button>'
                      +'<button type="button" class="btn btn-primary btn_cancel">' + text_cancel + '</button>'
                      +'</div>'
        });
        modal_box.open();

        container.querySelector(".btn_ok").onclick = function(){
            deferred.resolve(true);
            existing.delete(new_id);
            container.remove();
        }
        let _onclose = () => {
            deferred.resolve(false);
            modal_box.close();
            existing.delete(new_id);
            container.remove();
        };
        container.querySelector(".btn_cancel").onclick = _onclose;
        container.querySelector("#xclose").onclick = _onclose;
        return deferred.promise;
    };
})();


// Wrapper to obtain confirmation before actually removing a layer :
function remove_layer(name){
    name = name || this.parentElement.parentElement.getAttribute("layer_name");
    swal({
        title: "",
        text: i18next.t("app_page.common.remove_layer", {layer: name}),
        type: "warning",
        showCancelButton: true,
        allowOutsideClick: false,
        confirmButtonColor: "#DD6B55",
        confirmButtonText: i18next.t("app_page.common.delete") + "!",
        cancelButtonText: i18next.t("app_page.common.cancel")
    }).then(() => { remove_layer_cleanup(name); },
            () => { null; }
    );    // ^^^^^^^^^^^^ Do nothing on cancel, but this avoid having an "uncaught exeption (cancel)" comming in the console if nothing is set here
                //  ^^^^^^^^^^^^^^^^^^^^^^^ Not sure anymore :/
}

function remove_ext_dataset(){
    swal({
        title: "",
        text: i18next.t("app_page.common.remove_tabular"),
        type: "warning",
        showCancelButton: true,
        allowOutsideClick: false,
        confirmButtonColor: "#DD6B55",
        confirmButtonText: i18next.t("app_page.common.delete") + "!",
        cancelButtonText: i18next.t("app_page.common.cancel")
        }).then(() => {
                remove_ext_dataset_cleanup();
             }, () => { null; });
}

function remove_ext_dataset_cleanup(){
    field_join_map = new Array();
    joined_dataset = new Array();
    dataset_name = undefined;
    let ext_dataset_img = document.getElementById("img_data_ext");
    ext_dataset_img.setAttribute("src", "/static/img/b/addtabular.svg");
    ext_dataset_img.setAttribute("alt", "Additional dataset");
    ext_dataset_img.style.cursor = "pointer";
    ext_dataset_img.onclick = click_button_add_layer;
    let data_ext_txt = document.getElementById("data_ext");
    data_ext_txt.innerHTML = "<b>" + i18next.t("app_page.section1.add_ext_dataset") + "</b>";
    data_ext_txt.onclick = click_button_add_layer;
    document.getElementById("remove_dataset").remove();
    document.getElementById("join_section").innerHTML = "";
    document.getElementById('sample_zone').style.display = null;
    if(Object.getOwnPropertyNames(user_data).length == 0){
        document.getElementById("browse_button").disabled = true;
    }
    //$("#data_ext").qtip("destroy");
}

// Do some clean-up when a layer is removed
// Most of the job is to do when it's the targeted layer which is removed in
// order to restore functionnalities to their initial states
function remove_layer_cleanup(name){
     let g_lyr_name = "#"+name;

     // Making some clean-up regarding the result layer :
    if(current_layers[name].is_result){
        map.selectAll([".lgdf_", name].join('')).remove();
        if(result_data.hasOwnProperty(name))
            delete result_data[name];
        if(current_layers[name].hasOwnProperty("key_name")
           && current_layers[name].renderer.indexOf("Choropleth") < 0
           && current_layers[name].renderer.indexOf("Categorical") < 0)
            send_remove_server(name);
    }

    // Remove the layer from the map and from the layer manager :
    map.select(g_lyr_name).remove();
    document.querySelector('#sortable .' + name).remove()

    // Reset the panel displaying info on the targeted layer if she"s the one to be removed :
    if(current_layers[name].targeted){
        // Updating the top of the menu (section 1) :
        //$("#input_geom").qtip("destroy");
        d3.select("#img_in_geom")
            .attrs({"id": "img_in_geom", "class": "user_panel", "src": "/static/img/b/addgeom.png", "width": "24", "height": "24",  "alt": "Geometry layer"})
            .on('click',  click_button_add_layer);
        d3.select("#input_geom")
            .html(i18next.t("app_page.section1.add_geom"))
            .on('click', click_button_add_layer);
        document.getElementById("remove_target").remove();
        // Unfiling the fields related to the targeted functionnality:
        if(current_functionnality)
            fields_handler.unfill()

        // Update some global variables :
        field_join_map = [];
        user_data = new Object();
        targeted_layer_added = false;

        // Redisplay the bottom of the section 1 in the menu allowing user to select a sample layer :
        document.getElementById('sample_zone').style.display = null;

        // Restore the state of the bottom of the section 1 :
        document.getElementById("join_section").innerHTML = "";

        // If after this removal there isn't nor a targeted layer neither an external dataset :
        if(joined_dataset.length == 0)
            document.getElementById("browse_button").disabled = true;
    }

    // There is probably better ways in JS to delete the object,
    // but in order to make it explicit that we are removing it :
    delete current_layers[name];
}

// Change color of the background (ie the parent "svg" element on the top of which group of elements have been added)
function handle_bg_color(color){
    map.style("background-color", color);
}

function handle_click_hand(){
    var hb = d3.select('.hand_button');
    if(hb.classed("active")){
        hb.style('box-shadow', "none").classed("active", false);
        zoom.on("zoom", null);
    } else {
        hb.style('box-shadow', 'inset 2px 2px 1px black').classed("active", true);
        zoom.on("zoom", zoom_without_redraw);
        map.on("mousemove.zoomRect", null).on("mouseup.zoomRect", null);
    }
}


//////////////////////////////////////////////////////////////////////////////
// Zooming functions (some from http://bl.ocks.org/linssen/7352810)
//////////////////////////////////////////////////////////////////////////////

function zoom_without_redraw(){
    var rot_val = canvas_rotation_value || "";
    var transform;
    if(!d3.event || !d3.event.transform || !d3.event.sourceEvent){
        transform = d3.zoomTransform(svg_map);
        map.selectAll(".layer")
          .transition()
          .duration(50)
          .style("stroke-width", function(){
                let lyr_name = this.id;
                return current_layers[lyr_name].fixed_stroke
                        ? this.style.strokeWidth
                        : current_layers[lyr_name]['stroke-width-const'] / transform.k +  "px";
            })
          .attr("transform", transform.toString() + rot_val);
    } else {
        map.selectAll(".layer")
                  .transition()
                  .duration(50)
                  .style("stroke-width", function(){
                        let lyr_name = this.id;
                        return current_layers[lyr_name].fixed_stroke
                                ? this.style.strokeWidth
                                : current_layers[lyr_name]['stroke-width-const'] / d3.event.transform.k +  "px";
                    })
                  .attr("transform", d3.event.transform + rot_val);
    }

    if(scaleBar.displayed)
        scaleBar.update();

    if(window.legendRedrawTimeout){
        clearTimeout(legendRedrawTimeout);
    }
    window.legendRedrawTimeout = setTimeout(redraw_legends_symbols, 650);
    let zoom_params = svg_map.__zoom;
    document.getElementById("input-center-x").value = round_value(zoom_params.x, 2);
    document.getElementById("input-center-y").value = round_value(zoom_params.y, 2);
    document.getElementById("input-scale-k").value = round_value(zoom_params.k * proj.scale(), 2);
};

function redraw_legends_symbols(targeted_node){
    if(!targeted_node)
        var legend_nodes = document.querySelectorAll("#legend_root2");
    else
        var legend_nodes = [targeted_node];

    for(let i=0; i<legend_nodes.length; ++i){
        let layer_name = legend_nodes[i].classList[2].split('lgdf_')[1],
            rendered_field = current_layers[layer_name].rendered_field,
            nested = legend_nodes[i].getAttribute("nested"),
            display_value = legend_nodes[i].getAttribute("display"),
            visible = legend_nodes[i].style.visibility;

        let transform_param = legend_nodes[i].getAttribute("transform"),
            lgd_title = legend_nodes[i].querySelector("#legendtitle").innerHTML,
            lgd_subtitle = legend_nodes[i].querySelector("#legendsubtitle").innerHTML;

        let rect_fill_value = legend_nodes[i].getAttribute("visible_rect") == "true" ? {
            color: legend_nodes[i].querySelector("#under_rect").style.fill,
            opacity: legend_nodes[i].querySelector("#under_rect").style.fillOpacity
        } : undefined;

        legend_nodes[i].remove();
        createLegend_symbol(layer_name, rendered_field, lgd_title, lgd_subtitle, nested, rect_fill_value);
        let new_lgd = document.querySelector(["#legend_root2.lgdf_", layer_name].join(''));
        new_lgd.style.visibility = visible;
        new_lgd.setAttribute("display", display_value);
        if(transform_param)
            new_lgd.setAttribute("transform", transform_param);
    }
}

function interpolateZoom(translate, scale) {
    var self = this;
    var transform = d3.zoomTransform(svg_map);
    return d3.transition().duration(225).tween("zoom", function () {
        var iTranslate = d3.interpolate([transform.x, transform.y], translate),
            iScale = d3.interpolate(transform.k, scale);
        return function (t) {
            svg_map.__zoom.k = iScale(t);
            let _t =  iTranslate(t);
            svg_map.__zoom.x = _t[0];
            svg_map.__zoom.y = _t[1];
            zoom_without_redraw()
        };
    });
}

function zoomClick() {
    var direction = (this.id === 'zoom_in') ? 1 : -1,
        factor = 0.1,
        target_zoom = 1,
        center = [w / 2, h / 2],
        transform = d3.zoomTransform(svg_map),
        translate = [transform.x, transform.y],
        translate0 = [],
        l = [],
        view = {x: translate[0], y: translate[1], k: transform.k};

    d3.event.preventDefault();
    target_zoom = transform.k * (1 + factor * direction);

    translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
    view.k = target_zoom;
    l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

    view.x += center[0] - l[0];
    view.y += center[1] - l[1];

    interpolateZoom([view.x, view.y], view.k);
}


//////////////////////////////////////////////////////////////////////////////
// Rotation functions :
//////////////////////////////////////////////////////////////////////////////

function rotate_global(angle){
    canvas_rotation_value = ["rotate(", angle, ")"].join('');
    let zoom_transform = d3.zoomTransform(svg_map);

    map.selectAll("g.layer")
      .transition()
      .duration(10)
      .attr("transform", [canvas_rotation_value,
                          ",translate(", [zoom_transform.x, zoom_transform.y], "),",
                          "scale(", zoom_transform.k, ")"].join(''));
    if(northArrow.displayed){
        let current_rotate = !isNaN(+northArrow.svg_node.attr("rotate")) ? +northArrow.svg_node.attr("rotate") : 0;
        northArrow.svg_node.attr("transform", [
            "rotate(", +angle + current_rotate, ",",northArrow.x_center,",", northArrow.y_center, ")"
            ].join(''));
    }
    zoom_without_redraw();
};

function isInterrupted(proj_name){
    return (proj_name.indexOf("interrupted") > -1
            || proj_name.indexOf("armadillo") > -1
            || proj_name.indexOf("healpix") > -1);
}

function handleClipPath(proj_name){
    proj_name = proj_name.toLowerCase();
    if(isInterrupted(proj_name)){
        let defs_sphere = defs.node().querySelector("#sphere"),
            defs_clipPath = defs.node().querySelector("clipPath");
        if(defs_sphere){ defs_sphere.remove(); }
        if(defs_clipPath){ defs_clipPath.remove(); }

        defs.append("path")
            .datum({type: "Sphere"})
            .attr("id", "sphere")
            .attr("d", path);

        defs.append("clipPath")
            .attr("id", "clip")
          .append("use")
            .attr("xlink:href", "#sphere");

        map.selectAll(".layer")
            .attr("clip-path", "url(#clip)");

    } else {
        let defs_sphere = defs.node().querySelector("#sphere"),
            defs_clipPath = defs.node().querySelector("clipPath");
        if(defs_sphere){ defs_sphere.remove(); }
        if(defs_clipPath){ defs_clipPath.remove(); }
        map.selectAll(".layer")
                .attr("clip-path", null);
    }
}

function change_projection(proj_name) {
    var new_proj_name = proj_name.split('()')[0].split('.')[1];

    // Update global variables:
    proj = eval(proj_name);
    path = d3.geoPath().projection(proj).pointRadius(4);
    t = proj.translate();
    s = proj.scale();

    // Reset the projection center input :
    document.getElementById("form_projection_center").value = 0;
    document.getElementById("proj_center_value_txt").value = 0;

    // Do the reprojection :
    proj.translate([t[0], t[1]]).scale(s);
    map.selectAll("path").attr("d", path);

    // Set specifics mouse events according to the projection :
    if(new_proj_name.indexOf('Orthographic') > -1){
        var current_params = proj.rotate(),
            rotation_param = d3.select("#rotation_params");

        rotation_param.append("div").attr("class", "options_ortho")
                .html(i18next.t("app_page.section5.projection_center_phi"))
                .insert("input")
                .attrs({type: "range", id: "form_projection_phi"})
                .attrs({value: current_params[1], min: -180, max: 180, step: 0.5})
                .on("input", function(){handle_proj_center_button([null, this.value, null])})

        rotation_param.append("div").attr("class", "options_ortho")
                .html(i18next.t("app_page.section5.projection_center_gamma"))
                .insert("input")
                .attrs({type: "range", id: "form_projection_gamma"})
                .attrs({value: current_params[2], min: -90, max: 90, step: 0.5})
                .on("input", function(){handle_proj_center_button([null, null, this.value])});
    } else {
        d3.selectAll(".options_ortho").remove();
    }

    map.select("svg").on("mousedown", null)
                    .on("mousemove", null)
                    .on("mouseup", null);

    // Reset the scale of the projection and the center of the view :
    let layer_name = Object.getOwnPropertyNames(user_data)[0] || Object.getOwnPropertyNames(result_data)[0] || null;
    if(layer_name){
        scale_to_lyr(layer_name);
        center_map(layer_name);
        zoom_without_redraw();
    }

    // Reproject
    reproj_symbol_layer();

    // Set or remove the clip-path according to the projection:
    handleClipPath(new_proj_name);
}


// Function to switch the visibility of a layer the open/closed eye button
function handle_active_layer(name){
    var fill_value, parent_div, selec, at_end;

    if(document.getElementById("info_features").className == "active"){
        displayInfoOnMove();
        at_end = true;
    }
    if(!name) {
        selec = this;
        parent_div = selec.parentElement;
        name = parent_div.parentElement.getAttribute("layer_name");
    } else {
        selec = document.querySelector("#sortable ." + name + " .active_button");
        parent_div = selec.parentElement;
    }
    let func = function() { handle_active_layer(name); };
    if(selec.id == "eye_closed"){
        fill_value = 1;
        let eye_open = make_eye_button("open");
        eye_open.onclick = func;
        parent_div.replaceChild(eye_open, selec);
    } else {
        fill_value = 0;
        let eye_closed = make_eye_button("closed");
        eye_closed.onclick = func;
        parent_div.replaceChild(eye_closed, selec);
    }
    map.select("#"+name).style("visibility", fill_value == 0 ? "hidden" : "initial");
    map.selectAll(".lgdf_" + name).style("visibility", fill_value == 0 ? "hidden" : "initial");

    if(at_end){
        displayInfoOnMove();
    }
}

// Function to handle the title add and changes
function handle_title(txt){
    var title = d3.select("#map_title").select("text");
    if(title.node()){
        title.text(txt);
    } else {
        map.append("g")
             .attrs({"class": "legend legend_feature title", "id": "map_title"})
          .insert("text")
             .attrs({x: "50%", y: "8%",
                     "alignment-baseline": "middle", "text-anchor": "middle"})
             .styles({"font-family": "Arial, Helvetica, sans-serif",
                      "font-size": "20px", position: "absolute", color: "black"})
             .text(txt);
    }
}

function handle_title_properties(){
    var title = d3.select("#map_title").select("text");
    if(!title.node()){
        swal({title: "",
              text: i18next.t("app_page.common.error_no_title"),
              type: "error",
              allowOutsideClick: true,
              allowEscapeKey: true
            }).then( () => { null; },
                      () => { null; });
        return;
    }
    var title_props = {
        size: title.style("font-size"),
        color: title.style("fill"),
        position_x: title.attr("x"),
        position_y: title.attr("y"),
        font_family: title.style("font-family")
        };

    // Properties on the title are changed in real-time by the user then it will be rollback to original properties if Cancel is clicked
    make_confirm_dialog2("mapTitleitleDialogBox", i18next.t("app_page.title_box.title"), {width: 280})
        .then(function(confirmed){
            if(!confirmed)
                title.style("font-size", title_props.size)
                    .style("fill", title_props.color)
                    .style("font-family", title_props.font_family)
                    .attrs({x: title_props.position_x, y: title_props.position_y});
            });
    var box_content = d3.select(".mapTitleitleDialogBox").select(".modal-body").append("div");

    box_content.append("p").html(i18next.t("app_page.title_box.font_size"))
        .insert("input").attrs({type: "number", min: 2, max:40, step:1, value: +title_props.size.split("px")[0]}).style("width", "50px")
        .on("change", function(){  title.style("font-size", this.value + "px");  });
    box_content.append("p").html(i18next.t("app_page.title_box.xpos"))
        .insert("input").attrs({type: "number", min: 0, max:100, step:1, value: +title_props.position_x.split("%")[0]}).style("width", "50px")
        .on("change", function(){  title.attr("x", this.value + "%");  });
    box_content.append("p").html(i18next.t("app_page.title_box.ypos"))
        .insert("input").attrs({type: "number", min: 0, max:100, step:1, value: +title_props.position_y.split("%")[0]}).style("width", "50px")
        .on("change", function(){  title.attr("y", this.value + "%");  });
    box_content.append("p").html(i18next.t("app_page.title_box.font_color"))
        .insert("input").attrs({type: "color", value: title_props.color})
        .on("change", function(){  title.style("fill", this.value);  });
    var font_select = box_content.append("p").html(i18next.t("app_page.title_box.font_family"))
        .insert("select").attr("class", "params")
        .on("change", function(){  title.style("font-family", this.value); });
    available_fonts.forEach(function(font){
        font_select.append("option").text(font[0]).attr("value", font[1])
    });
    font_select.node().selectedIndex = available_fonts.map(d => d[1] == title_props.font_family ? "1" : "0").indexOf("1");
    // TODO : Allow the display a rectangle (resizable + selection color) under the title + allow to move the title with the mouse
    return;
}

// Function to change (one of ) the three rotations axis of a d3 projection
// and redraw all the path in respect to that
function handle_proj_center_button(param){
    let current_rotation = proj.rotate();
    if(param[0]){
        proj.rotate([param[0], current_rotation[1], current_rotation[2]]);
        map.selectAll(".layer").selectAll("path").attr("d", path);
    }
    if(param[1]){
        proj.rotate([current_rotation[0], param[1] - h/2, current_rotation[2]]);
        map.selectAll(".layer").selectAll("path").attr("d", path);
    }
    if(param[2]){
        proj.rotate([current_rotation[0], current_rotation[1], param[2] - h/2]);
        map.selectAll(".layer").selectAll("path").attr("d", path);
    }
    reproj_symbol_layer();
}

/** Function triggered by the change of map/canvas size
* @param {Array} shape - An Array of two elements : [width, height] to use;
*                generally only used once at the time so `shape` values
*                are like [null, 750] or [800, null]
*                but also works with the 2 params together like [800, 750])
*/
function canvas_mod_size(shape){
    if(shape[0]){
        w = +shape[0];
        map.attr("width", w)
            .call(zoom_without_redraw);
        map_div.style("width", w + "px");
        if(w + 360 + 30 < window.innerWidth){
            document.querySelector(".light-menu").style.right = '-30px';
        } else {
            document.querySelector(".light-menu").style.right = '0px';
        }
    }
    if(shape[1]){
        h = +shape[1];
        map.attr("height", h)
            .call(zoom_without_redraw);
        map_div.style("height", h + "px");
    }
    move_legends([w, h]);

    // Lets update the corresponding fields in the export section :
    let ratio,
        format = document.getElementById("select_png_format").value;
    if (format === "web"){
        ratio = 1
    } else if (format === "user_defined") {
        ratio = 118.11;
    } else {
        return;
    }
    document.getElementById("export_png_width").value = Math.round(w * ratio * 10) / 10;
    document.getElementById("export_png_height").value = Math.round(h * ratio * 10) / 10;
}

function patchSvgForFonts(){
    function getListUsedFonts(){
        let elems = [
            svg_map.querySelectorAll('text'),
            svg_map.querySelectorAll('p')
        ];
        let needed_definitions = [];
        elems.map(d => d ? d : []);
        for(let j=0; j < 2; j++){
            for(let i=0; i < elems[j].length; i++){
                let font_elem = elems[j][i].style.fontFamily;
                customs_fonts.forEach(font => {
                    if(font_elem.indexOf(font) > -1 && needed_definitions.indexOf(font) == -1){
                        needed_definitions.push(font);
                    }
                });
            }
        }
        return needed_definitions;
    }

    var needed_definitions = getListUsedFonts();
    if(needed_definitions.length == 0){
        return;
    } else {
        let fonts_definitions = Array.prototype.filter.call(
            document.styleSheets,
            i => i.href && i.href.indexOf("style-fonts.css") > -1 ? i : null
            )[0].cssRules;
        let fonts_to_add = needed_definitions.map(name => String(fonts_definitions[customs_fonts.indexOf(name)].cssText));
        let style_elem = document.createElement("style");
        style_elem.innerHTML = fonts_to_add.join(' ');
        svg_map.querySelector("defs").appendChild(style_elem);
    }
}

function unpatchSvgForFonts(){
    let defs_style = svg_map.querySelector("defs").querySelector("style");
    if(defs_style)
        defs_style.remove();
}

function patchSvgForInkscape(){
    svg_map.setAttribute("xmlns:inkscape", "http://www.inkscape.org/namespaces/inkscape");
    let elems = svg_map.querySelectorAll("g");
    for(let i = elems.length - 1; i > -1; i--){
        if(elems[i].id == ""){
            continue;
        } else if (Array.prototype.indexOf.call(elems[i].classList, "layer") > -1) {
            elems[i].setAttribute("inkscape:label", elems[i].id);
        } else if(elems[i].id.indexOf("legend") > -1){
            let layer_name = elems[i].className.baseVal.split("lgdf_")[1];
            elems[i].setAttribute("inkscape:label", "legend_" + layer_name);
        } else {
            elems[i].setAttribute("inkscape:label", elems[i].id);
        }
        elems[i].setAttribute("inkscape:groupmode", "layer");
    }
}

function unpatchSvgForInkscape(){
    svg_map.removeAttribute("xmlns:inkscape");
    let elems = svg_map.querySelectorAll("g");
    for(let i = elems.length - 1; i > -1; i--){
        if(elems[i].id == ""){
            continue;
        } else {
            elems[i].removeAttribute("inkscape:label");
            elems[i].removeAttribute("inkscape:groupmode");
        }
    }

}

function check_output_name(name, extension){
    let _part = name.split("."),
        regexp_name = new RegExp(/^[a-z0-9_]+$/i);
    if(regexp_name.test(_part[0]) && _part[0].length < 250){
        return _part[0] + "." + extension;
    } else {
        return "export." + extension;
    }
}

function export_compo_svg(output_name){
    output_name = check_output_name(output_name, "svg");
    patchSvgForInkscape();
    patchSvgForFonts();
    let targetSvg = document.getElementById("svg_map"),
        serializer = new XMLSerializer(),
        source = serializer.serializeToString(targetSvg);

    if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
        source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    source = ['<?xml version="1.0" standalone="no"?>\r\n', source].join('');

    let url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source),
        dl_link = document.createElement("a");

    dl_link.download = output_name;
    dl_link.href = url;
    dl_link.dataset.downloadurl = ["image/svg", dl_link.download, dl_link.href].join(':');
    document.body.appendChild(dl_link);
    dl_link.click();
    dl_link.remove();
    unpatchSvgForFonts();
    unpatchSvgForInkscape();
}

function _export_compo_png(type="web", scalefactor=1, output_name){
    output_name = check_output_name(output_name, "png");
    patchSvgForFonts();
    var targetCanvas = d3.select("body").append("canvas").attrs({id: "canvas_map_export", height: h, width: w}).node(),
        targetSVG = document.querySelector("#svg_map"),
        svg_xml = (new XMLSerializer()).serializeToString(targetSVG),
        ctx = targetCanvas.getContext('2d'),
        mime_type = "image/png",
        img = new Image();

    if(scalefactor != 1){
        try {
            changeResolution(targetCanvas, scalefactor);
        } catch (err) {
            console.log(err);
            display_error_during_computation("Too high resolution selected : " + String(err));
            return;
        }
    }
    img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg_xml);
    img.onload = function() {
        ctx.drawImage(img, 0, 0);
        try {
            var imgUrl = targetCanvas.toDataURL(mime_type),
                dl_link = document.createElement("a");
        } catch (err) {
            display_error_during_computation(String(err));
            return;
        }
        dl_link.download = output_name;
        dl_link.href = imgUrl;
        dl_link.dataset.downloadurl = [mime_type, dl_link.download, dl_link.href].join(':');
        document.body.appendChild(dl_link);
        dl_link.click();
        dl_link.remove();
        targetCanvas.remove();
        unpatchSvgForFonts();
    }
}

function export_layer_geo(layer, type, projec, proj4string){
    let extensions = new Map([
        ["GeoJSON", "geojson"],
        ["TopoJSON", "topojson"],
        ["ESRI Shapefile", "zip"],
        ["GML", "zip"],
        ["KML", "kml"]]);
    let formToSend = new FormData();
    formToSend.append("layer", layer);
    formToSend.append("layer_name", current_layers[layer].key_name);
    formToSend.append("format", type);
    if(projec == "proj4string")
        formToSend.append("projection", JSON.stringify({"proj4string" : proj4string}));
    else
        formToSend.append("projection", JSON.stringify({"name" : projec}));

    xhrequest("POST", '/get_layer2', formToSend, true)
        .then(data => {
            if(data.indexOf("Error:") == 0){
                swal({title: "Oops...",
                     text: i18next.t("app_page.common.error_msg", {msg: data.substring(6, data.length)}),
                     type: "error",
                     allowOutsideClick: false,
                     allowEscapeKey: false
                    }).then( () => { null; },
                              () => { null; });
                return;
            }
            let ext = extensions.get(type),
                dataStr;
            if(ext.indexOf("json") > -1)
                dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
            else if (ext.indexOf("kml") > -1)
                dataStr = "data:text/xml;charset=utf-8," + encodeURIComponent(data);
            else
                dataStr = "data:application/zip;base64," + data;

            let dlAnchorElem = document.getElementById('downloadAnchorElem');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", [layer, ext].join('.'));
            dlAnchorElem.click();
        }, error => {
            console.log(error);
        });
}

function make_export_layer_box(){
    let dialogBox = make_confirm_dialog2("dialogGeoExport",
                         i18next.t("app_page.export_box.geo_title_box"),
                         {text_ok: i18next.t("app_page.section5b.export_button")}),
        box_content = d3.select(".dialogGeoExport").select(".modal-body").append("div");

    let layer_names = Object.getOwnPropertyNames(current_layers).filter(name => {
        if(sample_no_values.has(name))
            return 0;
        else if(current_layers[name].renderer
                && (current_layers[name].renderer.indexOf("PropSymbols") > -1
                    || current_layers[name].renderer.indexOf("Dorling") > -1))
            return 0;
        return 1;
    });

    box_content.append("h3").html(i18next.t("app_page.export_box.options"));

    let selec_layer = box_content.append("p").html(i18next.t("app_page.export_box.option_layer"))
             .insert("select").attr("id", "layer_to_export");

    let selec_type = box_content.append("p").html(i18next.t("app_page.export_box.option_datatype"))
             .insert("select").attr("id", "datatype_to_use");

    let selec_projection = box_content.append("p").html(i18next.t("app_page.export_box.option_projection"))
             .insert("select").attr("id", "projection_to_use");

    let proj4_input = box_content.append("input")
                                .attr("id", "proj4str")
                                .style("display", "none")
                                .style("width", "200px");

    layer_names.forEach( name => {
        selec_layer.append("option").attr("value", name).text(name);
    });

    ["GeoJSON", "TopoJSON", "ESRI Shapefile", "GML", "KML"].forEach( name => {
        selec_type.append("option").attr("value", name).text(name);
    });

    [["Geographic coordinates / WGS84 (EPSG:4326)", "epsg:4326"],
     ["Web-mercator / WGS84 (EPSG:3857)", "epsg:3857"],
     ["LAEA Europe / ETRS89 (EPSG:3035)", "epsg:3035"],
     ["USA Albers Equal Area / NAD83", "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"],
     ["British National Grid / OSGB36 (EPSG:27700)", "epsg:27700"],
     ["Lambert-93 / RGF93-GRS80 (EPSG:2154)", "epsg:2154"],
     ["Eckert IV / WGS84", "+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "],
     ["Enter any valid Proj.4 string...", "proj4string"]].forEach(projection => {
        selec_projection.append("option").attr("value", projection[1]).text(projection[0]);
    });

    selec_type.on("change", function(){
        if(this.value == "TopoJSON" || this.value == "KML"){
            selec_projection.node().options.selectedIndex = 0;
            selec_projection.attr("disabled", true);
        } else {
            selec_projection.attr("disabled", null);
        }
    });

    selec_projection.on("change", function(){
        if(this.value == "proj4string")
            proj4_input.style("display", "initial");
        else
            proj4_input.style("display", "none");
    });

    let extensions = new Map([
        ["GeoJSON", "geojson"],
        ["TopoJSON", "topojson"],
        ["ESRI Shapefile", "zip"],
        ["GML", "zip"],
        ["KML", "kml"]]);

    dialogBox.then( confirmed => { if(confirmed){
        let layer = selec_layer.node().value,
            type = selec_type.node().value,
            projec = selec_projection.node().value;
        let formToSend = new FormData();
        formToSend.append("layer", layer);
        formToSend.append("layer_name", current_layers[layer].key_name);
        formToSend.append("format", type);
        if(projec == "proj4string")
            formToSend.append("projection", JSON.stringify({"proj4string" : proj4_input.node().value}));
        else
            formToSend.append("projection", JSON.stringify({"name" : projec}));

        xhrequest("POST", '/get_layer2', formToSend, true)
            .then( data => {
                if(data.indexOf("Error:") == 0){
                    swal({title: "Oops...",
                         text: i18next.t("app_page.common.error_msg", {msg: data.substring(6, data.length)}),
                         type: "error",
                         allowOutsideClick: false,
                         allowEscapeKey: false
                        }).then( () => { null; },
                                  () => { null; });
                    return;
                }
                let ext = extensions.get(type),
                    dataStr;
                if(ext.indexOf("json") > -1)
                    dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
                else if (ext.indexOf("kml") > -1)
                    dataStr = "data:text/xml;charset=utf-8," + encodeURIComponent(data);
                else
                    dataStr = "data:application/zip;base64," + data;

                let dlAnchorElem = document.getElementById('downloadAnchorElem');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", [layer, ext].join('.'));
                dlAnchorElem.click();

            }, error => {
                console.log(error);
            });
        dialogBox.dialog("destroy").remove();
    }});
}


/*
* Straight from http://stackoverflow.com/a/26047748/5050917
*
*/
function changeResolution(canvas, scaleFactor) {
    // Set up CSS size if it's not set up already
    if (!canvas.style.width)
        canvas.style.width = canvas.width + 'px';
    if (!canvas.style.height)
        canvas.style.height = canvas.height + 'px';

    canvas.width = Math.ceil(canvas.width * scaleFactor);
    canvas.height = Math.ceil(canvas.height * scaleFactor);
    var ctx = canvas.getContext('2d');
    ctx.scale(scaleFactor, scaleFactor);
}

// Only ask for confirmation before leaving page if things have been done
// (layer added, etc..)
window.addEventListener("beforeunload", event => {
    get_map_template().then(function(json_params){
        window.localStorage.removeItem("noname_app_project");
        window.localStorage.setItem("noname_map_project", json_params);
    });
    event.returnValue = (targeted_layer_added || Object.getOwnPropertyNames(result_data).length > 0)
                        ? "Confirm exit" : undefined;
});

// Remove some layers from the server when user leave the page
// (ie. result layers are removed but targeted layer and layout layers stay
// in cache as they have more chance to be added again)
window.addEventListener("unload", function(){
    let layer_names = Object.getOwnPropertyNames(current_layers).filter(name => {
        if(sample_no_values.has(name) || !(current_layers[name].hasOwnProperty("key_name")))
            return 0;
        else if(current_layers[name].targeted)
            return 0;
        else if(current_layers[name].renderer
                && (current_layers[name].renderer.indexOf("PropSymbols") > -1
                    || current_layers[name].renderer.indexOf("Dorling") > -1
                    || current_layers[name].renderer.indexOf("Choropleth") > -1
                    || current_layers[name].renderer.indexOf("Categorical") > -1))
            return 0;
        return 1;
    });
    if(layer_names.length){
        let formToSend = new FormData();
        layer_names.forEach(function(name){
            formToSend.append("layer_name", current_layers[name].key_name);
        });
        navigator.sendBeacon("/layers/delete", formToSend);
    }
}, false);

</script>
</body>
</html>
